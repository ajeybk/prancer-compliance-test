package rule

# https://docs.microsoft.com/en-us/azure/templates/microsoft.sql/2017-03-01-preview/servers/databases/vulnerabilityassessments

#
# Azure SQL Server advanced data security does not have an email alert recipient (265)
#

default db_ads_mail = null

db_ads_mail {
    lower(input.type) == "microsoft.sql/servers/databases/vulnerabilityassessments"
    input.properties.recurringScans.isEnabled == true
    input.properties.recurringScans.emailSubscriptionAdmins == true
    count(input.properties.recurringScans.emails) > 0
}

db_ads_mail = false {
    lower(input.type) == "microsoft.sql/servers/databases/vulnerabilityassessments"
    input.properties.recurringScans.isEnabled == false
}

db_ads_mail = false {
    lower(input.type) == "microsoft.sql/servers/databases/vulnerabilityassessments"
    input.properties.recurringScans.emailSubscriptionAdmins == false
}

db_ads_mail = false {
    lower(input.type) == "microsoft.sql/servers/databases/vulnerabilityassessments"
    count(input.properties.recurringScans.emails) == 0
}

db_ads_mail_err = "Azure SQL Server advanced data security does not have an email alert recipient" {
    db_ads_mail == false
}

#
# Azure SQL Server advanced data security does not send alerts to service and co-administrators (266)
#

default db_ads_alert = null

db_ads_alert {
    lower(input.type) == "microsoft.sql/servers/databases/vulnerabilityassessments"
    input.properties.recurringScans.isEnabled == true
    input.properties.recurringScans.emailSubscriptionAdmins == true
}

db_ads_alert = false {
    lower(input.type) == "microsoft.sql/servers/databases/vulnerabilityassessments"
    input.properties.recurringScans.isEnabled == false
}

db_ads_alert = false {
    lower(input.type) == "microsoft.sql/servers/databases/vulnerabilityassessments"
    input.properties.recurringScans.emailSubscriptionAdmins == false
}

db_ads_alert_err = "Azure SQL Server advanced data security does not send alerts to service and co-administrators" {
    db_ads_alert == false
}

#
# Azure SQL Server advanced data security is disabled (267)
#

default db_ads_scan = null

db_ads_scan {
    lower(input.type) == "microsoft.sql/servers/databases/vulnerabilityassessments"
    input.properties.recurringScans.isEnabled == true
}

db_ads_scan = false {
    lower(input.type) == "microsoft.sql/servers/databases/vulnerabilityassessments"
    input.properties.recurringScans.isEnabled == false
}

db_ads_scan_err = "Azure SQL Server advanced data security is disabled" {
    db_ads_scan == false
}
